# preview.ps1 fails on Windows when calling bash hook scripts (CRLF line endings)

## Summary

While running `preview.ps1` on Windows, the script fails during the API setup step with the following log:

```
>> Running API setup...
./infra/hooks/api/setup.sh: line 2: $'\r': command not found
>> Installing dependencies for the API service...
./infra/hooks/api/setup.sh: line 23: syntax error: unexpected end of file
API setup failed with exit code 2. Exiting.
```

This appears to be caused by DOS/Windows CRLF line endings in the bash hook scripts that are invoked from the PowerShell script using `bash`. When bash reads a script with CRLF endings, it may see `\r` carriage returns as part of lines which leads to the `$'\r': command not found` message and then a parsing error.

## Environment

- Repository: elbruno/contoso-travel-agents
- Branch: main
- OS where error observed: Windows (PowerShell)
- PowerShell command used: `.\preview.ps1`
- Node.js: v22.13.0
- npm: 11.4.2
- Docker: Docker version 29.1.3

## Steps to reproduce

1. On Windows, open PowerShell in the repository root.
2. Run `.\preview.ps1`.
3. Observe the script invoking `bash ./infra/hooks/api/setup.sh` and failing as shown above.

## Observed behavior

Bash reports carriage-return-related parse errors:

- `$'\\r': command not found`
- `syntax error: unexpected end of file`

Exit code propagated back to PowerShell script: `2` (causing `preview.ps1` to exit early).

## Root cause

The invoked bash script `infra/hooks/api/setup.sh` (and potentially other hook scripts) contain CRLF (Windows) line endings or extraneous Markdown/code-fence markers which confuse POSIX `bash` when run on Windows. `bash` expects LF line endings; when CRLF is present, it treats the CR (`\r`) as part of the token and throws the `$'\\r'` error and parsing failures.

In at least one case, the script file contained code-fence markers (triple backticks) and/or CRLF line endings which made the shell parsing fail. Running a quick local fix converting the file to UNIX line endings (LF) and removing any code-fence wrapper resolves the immediate error.

## Recommended fix

1. Ensure all `*.sh` hook scripts in `infra/hooks/**` use LF line endings. For example, run on a POSIX/bash environment or using Git attributes:

   - Convert files to LF (for example with `dos2unix` or an editor that can change line endings).
   - Add a `.gitattributes` entry to normalize line endings for shell scripts, e.g.:
     ```
     *.sh text eol=lf
     ```

2. Remove accidental Markdown code fences (```bash ... ```) from the top and bottom of script files â€” the scripts should be plain shell scripts beginning with a proper shebang line (e.g. `#!/bin/bash`).

3. As a defensive measure, `preview.ps1` could also check for and warn about CRLF in scripts it intends to run with `bash`.

## What I did locally

- Rewrote `infra/hooks/api/setup.sh` to remove code fences and ensure it has a proper `#!/bin/bash` shebang with LF endings. This resolves the `\r` parse error when running the script via `bash` on Windows under PowerShell.

## Files to check

- `infra/hooks/api/setup.sh`
- `infra/hooks/ui/setup.sh`
- `infra/hooks/mcp/setup.sh`
- Any other `infra/hooks/**/*.sh` files

## Suggested follow-ups

- Add a `.gitattributes` file to ensure consistent LF line endings for shell scripts.
- Optionally, update CI to check shell script line endings and fail early if CRLF is found.


---

(Automatically generated by a local run of `preview.ps1` and script inspection on 2025-12-19.)
