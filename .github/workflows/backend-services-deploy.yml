name: Backend Services Deploy

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - all
          - api
          - customer-query
          - destination-recommendation
          - echo-ping
          - itinerary-planning
  push:
    branches:
      - main
    paths:
      - 'src/api/**'
      - 'src/tools/customer-query/**'
      - 'src/tools/destination-recommendation/**'
      - 'src/tools/echo-ping/**'
      - 'src/tools/itinerary-planning/**'

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      customer-query: ${{ steps.changes.outputs.customer-query }}
      destination-recommendation: ${{ steps.changes.outputs.destination-recommendation }}
      echo-ping: ${{ steps.changes.outputs.echo-ping }}
      itinerary-planning: ${{ steps.changes.outputs.itinerary-planning }}
      deploy-all: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == '' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event.inputs.service }}" = "all" ]; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "customer-query=true" >> $GITHUB_OUTPUT
            echo "destination-recommendation=true" >> $GITHUB_OUTPUT
            echo "echo-ping=true" >> $GITHUB_OUTPUT
            echo "itinerary-planning=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.service }}" != "" ]; then
            echo "${{ github.event.inputs.service }}=true" >> $GITHUB_OUTPUT
          else
            # Check for changes in each service directory
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/api/"; then
              echo "api=true" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/tools/customer-query/"; then
              echo "customer-query=true" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/tools/destination-recommendation/"; then
              echo "destination-recommendation=true" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/tools/echo-ping/"; then
              echo "echo-ping=true" >> $GITHUB_OUTPUT
            fi
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/tools/itinerary-planning/"; then
              echo "itinerary-planning=true" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-api:
    name: Deploy API Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: src/api/package-lock.json

      - name: Install dependencies
        working-directory: src/api
        run: npm ci

      - name: Build
        working-directory: src/api
        run: npm run build

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Deploy API
        run: azd deploy api --no-prompt

  deploy-customer-query:
    name: Deploy Customer Query Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.customer-query == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        working-directory: src/tools/customer-query
        run: dotnet restore

      - name: Build
        working-directory: src/tools/customer-query
        run: dotnet build --configuration Release --no-restore

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Deploy Customer Query
        run: azd deploy customer-query --no-prompt

  deploy-destination-recommendation:
    name: Deploy Destination Recommendation Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.destination-recommendation == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '24'

      - name: Build
        working-directory: src/tools/destination-recommendation
        run: mvn clean install -DskipTests

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Deploy Destination Recommendation
        run: azd deploy destination-recommendation --no-prompt

  deploy-echo-ping:
    name: Deploy Echo Ping Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.echo-ping == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: src/tools/echo-ping/package-lock.json

      - name: Install dependencies
        working-directory: src/tools/echo-ping
        run: npm ci

      - name: Build
        working-directory: src/tools/echo-ping
        run: npm run build

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Deploy Echo Ping
        run: azd deploy echo-ping --no-prompt

  deploy-itinerary-planning:
    name: Deploy Itinerary Planning Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.itinerary-planning == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: src/tools/itinerary-planning
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Deploy Itinerary Planning
        run: azd deploy itinerary-planning --no-prompt

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-customer-query, deploy-destination-recommendation, deploy-echo-ping, deploy-itinerary-planning]
    if: always() && !cancelled()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Log in with Azure
        run: |
          azd auth login \
            --client-id "$AZURE_CLIENT_ID" \
            --federated-credential-provider "github" \
            --tenant-id "$AZURE_TENANT_ID"

      - name: Check deployment status
        run: |
          echo "Checking deployment status..."
          azd show --output json
